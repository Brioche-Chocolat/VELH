<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Template: Image + Musique + Dialogue r√©tro + Choix</title>
  <style>
    :root{
      --bg:#000000;           /* fond NOIR */
      --ink:#f2f2f2;          /* texte principal clair */
      --pane:rgba(0,0,0,.72); /* panneau de dialogue sombre et translucide */
      --pane-border:#222;     /* contour panneau */
      --accent:#ffffff;       /* boutons */
      --accent-ink:#000;      /* texte boutons */
      --muted:#bdbdbd;        /* sous-texte */
      --radius:14px;          /* arrondi UI */
      --shadow:0 16px 60px rgba(0,0,0,.4);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --vh: 1vh;              /* fallback mobile */
      --hudH: 180px;          /* hauteur HUD calcul√©e en JS */
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--ink)}

    /* ‚ùó Pas de scroll. On force le layout = 100vh d√©coup√© en 2 lignes :
       - stage: calc(100vh - HUD)
       - HUD: hauteur exacte du panneau (maj en JS)
    */
    body{
      height: calc(var(--vh) * 100);
      display: grid;
      grid-template-rows: calc(var(--vh) * 100 - var(--hudH)) var(--hudH);
      overflow: hidden;
    }
    @supports (height: 100dvh) {
      body{
        height: 100dvh;
        grid-template-rows: calc(100dvh - var(--hudH)) var(--hudH);
      }
    }

    /* Sc√®ne: image toujours enti√®re, centr√©e */
    .stage{
      min-height: 0;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .stage img{
      max-height: 100%;
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;   /* ne coupe jamais */
      object-position: center;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
      background: transparent;
    }

    /* HUD (jamais sur l'image) */
    .hud{ height: var(--hudH); overflow: hidden; padding:12px 12px max(16px, env(safe-area-inset-bottom)); }
    .dialog{
      margin:0 auto; width:min(1100px, 100%);
      background:var(--pane);
      border:1px solid var(--pane-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px 14px 10px;
      backdrop-filter:saturate(1.1) blur(3px);
    }
    .name{font:700 12px/1 var(--mono); letter-spacing:.02em; color:var(--muted); margin:0 0 6px 2px}
    .text{font:500 14px/1.45 var(--mono); min-height:3.2em; white-space:pre-wrap}
    .caret{display:inline-block; width:8px; height:1.1em; translate:0 .15em; background:currentColor; animation:blink 1s steps(1,end) infinite}
    @keyframes blink{50%{opacity:0}}

    .bar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px}
    .choices{display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:10px}
    .btn{appearance:none; border:2px solid var(--accent); background:var(--accent); color:var(--accent-ink); border-radius:12px; padding:12px 14px; cursor:pointer; font:700 14px/1 var(--mono); letter-spacing:.02em;}
    .btn.alt{background:transparent; color:var(--accent);}
    .btn:focus{outline:3px solid rgba(255,255,255,.25); outline-offset:2px}
    .hint{font:400 11px/1 var(--mono); color:var(--muted)}

    .audio-toggle{background:rgba(255,255,255,.1); color:#fff; border:0; border-radius:999px; padding:10px 14px; font:600 13px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; cursor:pointer; box-shadow:var(--shadow)}
    .audio-toggle[aria-pressed="true"]{background:rgba(255,255,255,.2)}

    .gate{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; text-align:center; padding:24px}
    .gate-inner{max-width:520px; background:#0f0f0f; border:1px solid #222; border-radius:16px; box-shadow:var(--shadow); padding:20px 24px; color:#fff}
    .gate h2{margin:0 0 8px; font:700 20px/1.2 system-ui}
    .gate p{margin:0 0 16px; color:#ddd}
    .gate button{appearance:none; border:0; background:#fff; color:#000; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700}
  </style>
</head>
<body>
  <!-- Sc√®ne (ne chevauche jamais le HUD, hauteur = viewport - HUD) -->
  <div class="stage" role="img" aria-label="Sc√®ne visuelle">
    <img id="scene" src="couverture-2-1.png" alt="Sc√®ne" />
  </div>

  <!-- HUD (bandeau de dialogue + choix) -->
  <div class="hud" aria-live="polite">
    <div class="dialog" id="dialog">
      <div class="name" id="speaker">NARRATEUR</div>
      <div class="text" id="typeText"></div>
      <div class="bar">
        <div class="choices" id="choices" hidden>
          <button class="btn" id="choiceA">‚ñ∂ Choix A</button>
          <button class="btn alt" id="choiceB">‚ñ∂ Choix B</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <div class="hint" id="hint">Espace = afficher la ligne / avancer</div>
          <button id="audioToggle" class="audio-toggle" aria-pressed="false" aria-label="Activer le son">üîà Son</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio de fond -->
  <audio id="bgm" src="street-noise-24118.mp3" preload="auto" loop></audio>

  <!-- Panneau d'autorisation audio (si autoplay bloqu√©) -->
  <div id="gate" class="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="gate-inner">
      <h2 id="gateTitle">Activer le son</h2>
      <p>Ton navigateur bloque la lecture automatique. Clique sur le bouton pour lancer la musique.</p>
      <button id="gateBtn">‚ñ∂Ô∏è Lancer la musique</button>
    </div>
  </div>

  <script>
  (function(){
    // ---------------- Config sc√©nario ----------------
    const DIALOG_SPEED = 80; // ms/char (lent)
    const LINES = [
      "‚Ä¶Le vent se l√®ve sur la ville endormie.",
      "Une silhouette s'avance vers la place centrale‚Ä¶",
      "Un choix s'impose."
    ];
    const CHOICES = {
      a: { label: "Suivre l'ombre", action: () => location.href = '#ombre' },
      b: { label: "Prendre la lumi√®re", action: () => location.href = '#lumiere' },
    };

    // --------------- S√©lecteurs & √©l√©ments ---------------
    const textEl = document.getElementById('typeText');
    const choicesEl = document.getElementById('choices');
    const choiceA = document.getElementById('choiceA');
    const choiceB = document.getElementById('choiceB');
    const hint = document.getElementById('hint');

    const audio = document.getElementById('bgm');
    const toggle = document.getElementById('audioToggle');
    const gate = document.getElementById('gate');
    const gateBtn = document.getElementById('gateBtn');

    const hud = document.querySelector('.hud');
    const dialog = document.getElementById('dialog');

    // --------------- Mesure HUD & vh (sans scroll) ---------------
    function setVhVar(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    function setHudHeight(){
      // mesure r√©elle de la bo√Æte de dialogue + padding .hud
      const pad = 12 + Math.max(16, (window.visualViewport ? 0 : 0));
      const h = Math.ceil(dialog.getBoundingClientRect().height + pad);
      document.documentElement.style.setProperty('--hudH', h + 'px');
    }

    // recalcul pendant la frappe (taille texte change)
    function scheduleHudMeasure(){
      requestAnimationFrame(()=>{ setHudHeight(); });
    }

    // --------------- Typewriter ----------------
    let lineIdx = 0, charIdx = 0, typing = false, skip = false;

    function setChoicesVisible(v){ choicesEl.hidden = !v; scheduleHudMeasure(); }

    function setButtons(){
      choiceA.textContent = `‚ñ∂ ${CHOICES.a.label}`;
      choiceB.textContent = `‚ñ∂ ${CHOICES.b.label}`;
      choiceA.onclick = CHOICES.a.action;
      choiceB.onclick = CHOICES.b.action;
    }

    function typeLine(line){
      typing = true; skip = false; hint.style.visibility = 'visible';
      textEl.innerText = '';
      charIdx = 0;
      const tick = () => {
        scheduleHudMeasure();
        if (skip) { textEl.innerText = line; typing = false; hint.style.visibility = 'hidden'; showNext(); return; }
        if (charIdx < line.length) {
          textEl.innerText += line[charIdx++];
          setTimeout(tick, DIALOG_SPEED);
        } else {
          typing = false; hint.style.visibility = 'hidden'; showNext();
        }
      };
      tick();
    }

    function showNext(){
      scheduleHudMeasure();
      if (lineIdx < LINES.length - 1) {
        lineIdx++;
        setTimeout(()=> typeLine(LINES[lineIdx]), 400);
      } else {
        setChoicesVisible(true);
      }
    }

    document.addEventListener('keydown', (e)=>{
      if (e.key === ' ' || e.key === 'Spacebar') {
        e.preventDefault();
        if (typing) skip = true; else showNext();
      }
    });

    // --------------- Audio (autoplay + toggle) ---------------
    function setToggleState() {
      const muted = audio.muted || audio.volume === 0 || audio.paused;
      toggle.setAttribute('aria-pressed', String(!muted));
      toggle.textContent = muted ? 'üîá Muet' : 'üîä Son';
      toggle.setAttribute('aria-label', muted ? 'Activer le son' : 'Couper le son');
    }

    async function tryAutoplay() {
      try { audio.volume = 1.0; audio.muted = false; await audio.play(); gate.style.display = 'none'; }
      catch { gate.style.display = 'flex'; }
      finally { setToggleState(); }
    }

    toggle.addEventListener('click', async () => {
      if (audio.paused) { try { await audio.play(); } catch(e) {} }
      audio.muted = !audio.muted; setToggleState();
    });

    gateBtn.addEventListener('click', async () => {
      try { audio.muted = false; await audio.play(); gate.style.display = 'none'; } catch (e) {}
      setToggleState();
    });

    // --------------- Bootstrap ---------------
    function boot(){
      setVhVar();
      setHudHeight();
      tryAutoplay();
      typeLine(LINES[lineIdx]);
      setButtons();
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') boot();
    else document.addEventListener('DOMContentLoaded', boot);

    // --------------- R√©activit√© ---------------
    window.addEventListener('resize', ()=>{ setVhVar(); setHudHeight(); });
    window.addEventListener('orientationchange', ()=>{ setVhVar(); setHudHeight(); });
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', ()=>{ setVhVar(); setHudHeight(); });
    }

    // --------------- Tests rapides (console) ---------------
    (function runSmokeTests(){
      const results = [];
      const test = (name, fn)=>{ try{ fn(); results.push({test:name, ok:true}); }catch(e){ results.push({test:name, ok:false, msg:e.message}); } };
      test('image pr√©sente', ()=> { if(!document.getElementById('scene').src) throw new Error('src manquant'); });
      test('audio pr√©sent', ()=> { if(!audio) throw new Error('audio manquant'); });
      test('2 choix configur√©s', ()=> { if(!CHOICES.a?.label || !CHOICES.b?.label) throw new Error('labels manquants'); });
      console.table(results);
    })();
  })();
  </script>
</body>
</html>